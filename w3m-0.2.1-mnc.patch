Index: main.c
===================================================================
RCS file: /home/tsuchiya/cvsroot/w3m/main.c,v
retrieving revision 1.1.1.3
diff -u -u -r1.1.1.3 main.c
--- main.c	2001/03/23 04:38:30	1.1.1.3
+++ main.c	2001/04/02 04:06:31
@@ -59,8 +59,10 @@
 int w3m_dump = 0;
 int w3m_dump_source = 0;
 int w3m_dump_head = 0;
+int w3m_dump_extra = 0;
 static void dump_source(Buffer *);
 static void dump_head(Buffer *);
+static void dump_extra(Buffer *);
 int prec_num = 0;
 int prev_key = -1;
 int on_target = 1;
@@ -234,16 +236,64 @@
 	    }
 	    else if (!strcmp("-h", argv[i]))
 		help();
+	    else if (!strcmp("-dump", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_dump = TRUE;
+		w3m_dump_source = FALSE;
+		w3m_dump_head = FALSE;
+		w3m_halfdump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
+	    else if (!strcmp("-dump_source", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_dump = TRUE;
+		w3m_dump_source = TRUE;
+		w3m_dump_head = FALSE;
+		w3m_halfdump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
+	    else if (!strcmp("-dump_head", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_dump = TRUE;
+		w3m_dump_head = TRUE;
+		w3m_dump_source = FALSE;
+		w3m_halfdump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
+	    else if (!strcmp("-dump_both", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_dump = TRUE;
+		w3m_dump_head = TRUE;
+		w3m_dump_source = TRUE;
+		w3m_halfdump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
+	    else if (!strcmp("-dump_extra", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_dump = TRUE;
+		w3m_dump_head = TRUE;
+		w3m_dump_source = TRUE;
+		w3m_dump_extra = TRUE;
+		w3m_halfdump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
+	    else if (!strcmp("-halfdump", argv[i])) {
+		argv[i] = "-dummy";
+		w3m_halfdump = TRUE;
+		w3m_dump = FALSE;
+		if (COLS == 0)
+		    COLS = 80;
+	    }
 	}
     }
 
     /* initializations */
     init_rc(config_file);
-    initKeymap();
-#ifdef MENU
-    initMenu();
-    CurrentMenuData = NULL;
-#endif				/* MENU */
 #ifdef USE_COOKIE
     initCookie();
 #endif				/* USE_COOKIE */
@@ -367,36 +417,6 @@
 		    WrapSearch = TRUE;
 		}
 	    }
-	    else if (!strcmp("-dump", argv[i])) {
-		w3m_dump = TRUE;
-		w3m_dump_source = FALSE;
-		w3m_dump_head = FALSE;
-		w3m_halfdump = FALSE;
-		if (COLS == 0)
-		    COLS = 80;
-	    }
-	    else if (!strcmp("-dump_source", argv[i])) {
-		w3m_dump = TRUE;
-		w3m_dump_source = TRUE;
-		w3m_dump_head = FALSE;
-		w3m_halfdump = FALSE;
-		if (COLS == 0)
-		    COLS = 80;
-	    }
-	    else if (!strcmp("-dump_head", argv[i])) {
-		w3m_dump = TRUE;
-		w3m_dump_head = TRUE;
-		w3m_dump_source = FALSE;
-		w3m_halfdump = FALSE;
-		if (COLS == 0)
-		    COLS = 80;
-	    }
-	    else if (!strcmp("-halfdump", argv[i])) {
-		w3m_halfdump = TRUE;
-		w3m_dump = FALSE;
-		if (COLS == 0)
-		    COLS = 80;
-	    }
 	    else if (!strcmp("-halfload", argv[i])) {
 		w3m_halfload = TRUE;
 		w3m_dump = FALSE;
@@ -526,13 +546,20 @@
     }
     if (w3m_backend)
 	backend();
-    if (!w3m_dump && !w3m_halfdump)
+    if (!w3m_dump && !w3m_halfdump) {
+	initKeymap();
+#ifdef MENU
+	initMenu();
+	CurrentMenuData = NULL;
+#endif				/* MENU */
 	fmInit();
+    }
     orig_GC_warn_proc = GC_set_warn_proc(wrap_GC_warn_proc);
     if (w3m_halfdump)
 	printf("<pre>\n");
 
     if (load_argc == 0) {
+	/* no URL specified */
 	if (!isatty(0)) {
 	    redin = newFileStream(fdopen(dup(0), "rb"), (void (*)()) pclose);
 	    newbuf = openGeneralPagerBuffer(redin);
@@ -594,7 +621,7 @@
     }
     for (; i < load_argc; i++) {
 	if (i >= 0) {
-	    if (w3m_dump && w3m_dump_head) {
+	    if (w3m_dump && w3m_dump_head && !w3m_dump_source) {
 		request = New(FormList);
 		request->method = FORM_METHOD_HEAD;
 		newbuf = loadGeneralFile(load_argv[i], NULL, NO_REFERER, 0, request);
@@ -632,23 +659,6 @@
 	    deleteFiles();
 	    exit(0);
 	}
-	if (w3m_dump) {
-	    Currentbuf = Firstbuf = newbuf;
-	    if (w3m_dump_source)
-		dump_source(Currentbuf);
-	    else if (w3m_dump_head)
-		dump_head(Currentbuf);
-	    else {
-		if (Currentbuf->frameset != NULL && RenderFrame)
-		    rFrame();
-		saveBuffer(Currentbuf, stdout);
-	    }
-	    deleteFiles();
-#ifdef USE_COOKIES
-	    save_cookies();
-#endif				/* USE_COOKIES */
-	    exit(0);
-	}
 	if (Currentbuf == NULL)
 	    Firstbuf = Currentbuf = newbuf;
 	else {
@@ -660,11 +670,33 @@
 	    rFrame();
 	    Currentbuf = newbuf;
 	}
+	if (w3m_dump) {
+	    if (w3m_dump_extra) {
+		dump_extra(Currentbuf);
+	    }
+	    if (w3m_dump_head)
+		dump_head(Currentbuf);
+	    if (w3m_dump_source)
+		dump_source(Currentbuf);
+	    if (!w3m_dump_head && !w3m_dump_source) {
+		if (Currentbuf->frameset != NULL && RenderFrame)
+		    rFrame();
+		saveBuffer(Currentbuf, stdout);
+	    }
+	}
 #ifdef BUFINFO
 	saveBufferInfo();
 #endif
 
     }
+    if (w3m_dump) {
+	deleteFiles();
+#ifdef USE_COOKIES
+	save_cookies();
+#endif				/* USE_COOKIES */
+	exit(0);
+    }
+
     if (!Firstbuf || Firstbuf == NO_BUFFER) {
 	if (newbuf == NO_BUFFER) {
 	    if (fmInitialized)
@@ -776,6 +808,17 @@
 	printf("%s", ti->ptr);
     }
     puts("");
+}
+
+static void
+dump_extra(Buffer * buf)
+{
+    printf("W3m-current-url: %s\n",parsedURL2Str(&buf->currentURL)->ptr);
+    if (buf->baseURL)
+	printf("W3m-base-url: %s\n",parsedURL2Str(buf->baseURL)->ptr);
+#ifdef JP_CHARSET
+    printf("W3m-document-charset: %s\n", code_to_str(buf->document_code));
+#endif
 }
 
 void
