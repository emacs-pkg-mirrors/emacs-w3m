prefix  = @prefix@
lispdir = @lispdir@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
ADDITIONAL_LOAD_PATH = @ADDITIONAL_LOAD_PATH@
ICONDIR = @ICONDIR@

@SET_MAKE@
EMACS   = @EMACS@
FLAGS   = -q -no-site-file -batch -l w3mhack.el $(ADDITIONAL_LOAD_PATH)
ECC     = $(EMACS) $(FLAGS) -f batch-byte-compile

MODULES = $(EMACS) $(FLAGS) -f w3mhack-examine-modules

PACKAGE = w3m_el
TARBALL = $(PACKAGE)-$(VERSION).tar.gz
DISTDIR = $(PACKAGE)-$(VERSION)
DOCS    = COPYING ChangeLog README README.ja

.SUFFIXES:
.SUFFIXES: .elc .el

default:
	@modules="`$(MODULES) 2>/dev/null`";\
	if test -z "$$modules"; then\
	  echo "Error has occurred while examining w3m modules;";\
	  echo "$(MODULES)";\
	  $(MODULES);\
	else\
	  echo "$(MAKE) -k $$modules";\
	  $(MAKE) -k $$modules;\
	fi

.el.elc:
	$(ECC) $<

install: default
	@for p in ChangeLog *.el; do\
	  echo " $(INSTALL_DATA) $$p $(lispdir)/$$p";\
	  $(INSTALL_DATA) $$p $(lispdir)/$$p;\
	done
	@for p in *.elc; do\
	  echo " $(INSTALL_DATA) $$p $(lispdir)/$$p";\
	  $(INSTALL_DATA) $$p $(lispdir)/$$p;\
	done

install-icons:
	@if test $(ICONDIR) = NONE; then\
	  echo "You don't have to install icons for $(EMACS).";\
	else\
	  if test -d $(ICONDIR); then\
	    cd icons;\
	    for i in *.xpm; do\
	      echo " $(INSTALL_DATA) $$i $(ICONDIR)/$$i";\
	      $(INSTALL_DATA) $$i $(ICONDIR)/$$i;\
	    done;\
	  else\
	    echo "You shuold mkdir $(ICONDIR) in advance.";\
	  fi\
	fi

dist:
	$(MAKE) VERSION=`$(EMACS) $(FLAGS) -f w3mhack-version 2>/dev/null` tarball

tarball:
	-rm -f $(TARBALL) `basename $(TARBALL) .gz`
	mkdir $(DISTDIR)
	cp -p $(DOCS) *.el $(DISTDIR)
	tar -cf `basename $(TARBALL) .gz` $(DISTDIR)
	gzip -9 `basename $(TARBALL) .gz`
	rm -rf $(DISTDIR)

clean:
	-rm -rf *~ *.elc $(PACKAGE)*

distclean: clean
	-rm -f configure config.log config.status config.cache Makefile
